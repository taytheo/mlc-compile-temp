name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.11"
        activate-environment: mlc

    - name: Install dependencies
      run: |
        brew install cmake git-lfs
        git lfs install
        # Install Rust (required for tokenizers)
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        rustc --version

    - name: Clone MLC-LLM source
      run: |
        git clone --depth 1 https://github.com/mlc-ai/mlc-llm.git
        cd mlc-llm
        git submodule update --init --recursive

    - name: Install MLC-LLM Python package
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install huggingface_hub

    - name: Patch batch_spec_verify.py bug (bool type issue)
      run: |
        SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
        echo "=== Site packages: $SITE_PKG ==="
        
        # Find all Python files with bool type issues and patch them
        echo "=== Searching for files with bool type issues ==="
        grep -r "= False\|= True\|_var(\"bool\")\|\"bool\", scope=" "$SITE_PKG/mlc_llm/op/" || true
        
        # Patch all files in mlc_llm/op/ directory
        for F in "$SITE_PKG/mlc_llm/op/"*.py; do
          if [ -f "$F" ]; then
            echo "Checking: $F"
            if grep -q "_var(\"bool\")\|\"bool\", scope=\|= False\|= True" "$F"; then
              echo "Patching bool issues in: $F"
              
              # Change bool type declarations to int32
              sed -i '' 's/_var("bool")/_var("int32")/g' "$F"
              sed -i '' 's/"bool", scope="shared"/"int32", scope="shared"/g' "$F"
              sed -i '' 's/"bool", scope="local"/"int32", scope="local"/g' "$F"
              sed -i '' "s/(1,), \"bool\"/(1,), \"int32\"/g" "$F"
              
              # Change boolean assignments to int (be careful with context)
              # Only change assignments like var[0] = False/True
              sed -i '' 's/\[0\] = False/[0] = 0/g' "$F"
              sed -i '' 's/\[0\] = True/[0] = 1/g' "$F"
              
              # Change T.Not(var[0]) to var[0] == 0
              sed -i '' 's/T\.Not(\([^)]*\)\[0\])/\1[0] == 0/g' "$F"
              
              # Change if var[0]: to if var[0] != 0:
              sed -i '' 's/if \([a-z_]*\)\[0\]:$/if \1[0] != 0:/g' "$F"
              
              echo "Done patching: $F"
            fi
          fi
        done
        
        echo "=== Verifying patches ==="
        grep -r "_var(\"bool\")\|\"bool\", scope=" "$SITE_PKG/mlc_llm/op/" && echo "WARNING: Some bool types remain" || echo "All bool types patched"

    - name: Create mlc-package-config.json for Qwen3
      run: |
        cd mlc-llm/ios/MLCChat
        cat > mlc-package-config.json << 'EOF'
        {
          "device": "iphone",
          "model_list": [
            {
              "model": "HF://mlc-ai/Qwen3-4B-q4f16_1-MLC",
              "model_id": "Qwen3-4B-q4f16_1",
              "estimated_vram_bytes": 3000000000,
              "overrides": {
                "prefill_chunk_size": 128,
                "context_window_size": 2048
              }
            }
          ]
        }
        EOF
        cat mlc-package-config.json

    - name: Build iOS libraries with mlc_llm package
      run: |
        cd mlc-llm/ios/MLCChat
        export MLC_LLM_SOURCE_DIR=$(cd ../.. && pwd)
        echo "MLC_LLM_SOURCE_DIR=$MLC_LLM_SOURCE_DIR"
        # Run the package command
        python -m mlc_llm package

    - name: List built artifacts
      run: |
        cd mlc-llm/ios/MLCChat
        echo "=== dist directory ==="
        ls -laR dist/ || echo "dist not found"
        echo "=== lib directory ==="
        ls -la dist/lib/ || echo "lib not found"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-compiled
        path: |
          mlc-llm/ios/MLCChat/dist/
        retention-days: 30
