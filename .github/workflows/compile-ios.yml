name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 120
    env:
      MLC_LLM_HOME: /Users/runner/work/mlc-compile-temp/mlc-compile-temp/mlc-llm
    
    steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install dependencies
      run: |
        pip install numpy decorator attrs typing_extensions psutil scipy tornado
        brew install ninja
        
    - name: Clone MLC-LLM
      run: |
        git clone --recursive https://github.com/mlc-ai/mlc-llm.git
        cd mlc-llm
        ls -la
        ls -la 3rdparty/tvm/
        
    - name: Build MLC-LLM
      run: |
        cd mlc-llm
        mkdir -p build && cd build
        
        TVM_PATH="$(cd ../3rdparty/tvm && pwd)"
        
        cat > config.cmake << EOF
        set(TVM_SOURCE_DIR "$TVM_PATH")
        set(USE_CUDA OFF)
        set(USE_METAL ON)
        set(USE_VULKAN OFF)
        set(USE_OPENCL OFF)
        set(USE_FLASHINFER OFF)
        set(CMAKE_BUILD_TYPE Release)
        EOF
        
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -GNinja
        
        ninja -j$(sysctl -n hw.ncpu)
        
        echo "=== Built libraries ==="
        find . -name "*.dylib" -o -name "*.so" | head -20
        ls -la *.dylib 2>/dev/null || echo "No dylib in current dir"
        ls -la lib*.* 2>/dev/null || echo "No lib files"
        
    - name: Verify build outputs
      run: |
        cd mlc-llm/build
        echo "=== All built files ==="
        ls -la
        
        echo "=== Looking for tvm libraries ==="
        find .. -name "libtvm*.dylib" -o -name "libtvm*.so" 2>/dev/null | head -20
        
    - name: Download Model
      run: |
        pip install huggingface_hub
        huggingface-cli download mlc-ai/Qwen3-4B-q4f16_1-MLC --local-dir ./model
        cat ./model/mlc-chat-config.json
        
    - name: Generate config and Compile for iOS
      run: |
        cd mlc-llm
        
        # Set all necessary paths
        export PYTHONPATH=$(pwd)/python:$(pwd)/3rdparty/tvm/python:$(pwd)/3rdparty/tvm/3rdparty/tvm-ffi/python:$PYTHONPATH
        export TVM_LIBRARY_PATH=$(pwd)/build
        export MLC_LLM_BUILD_PATH=$(pwd)/build
        
        # Debug: Check if libraries exist
        echo "=== Checking library paths ==="
        ls -la $(pwd)/build/libtvm* 2>/dev/null || echo "No libtvm in build"
        ls -la $(pwd)/build/libmlc* 2>/dev/null || echo "No libmlc in build"
        
        # Try to find the actual library location
        echo "=== Finding all .dylib files ==="
        find $(pwd) -name "*.dylib" 2>/dev/null | head -30
        
        # Verify Python can import
        echo "=== Testing imports ==="
        python -c "
        import sys
        sys.path.insert(0, '$(pwd)/python')
        sys.path.insert(0, '$(pwd)/3rdparty/tvm/python')
        sys.path.insert(0, '$(pwd)/3rdparty/tvm/3rdparty/tvm-ffi/python')
        
        import os
        os.environ['TVM_LIBRARY_PATH'] = '$(pwd)/build'
        
        try:
            import tvm_ffi
            print('tvm_ffi imported')
        except Exception as e:
            print(f'tvm_ffi error: {e}')
            
        try:
            import tvm
            print('tvm imported')
        except Exception as e:
            print(f'tvm error: {e}')
        "
        
        mkdir -p ../config
        mkdir -p ../output
        
        # Generate config
        python -m mlc_llm gen_config ../model \
          --quantization q4f16_1 \
          --prefill-chunk-size 128 \
          --context-window-size 4096 \
          --max-batch-size 1 \
          --conv-template qwen2 \
          --output ../config
        
        echo "=== Generated config ==="
        cat ../config/mlc-chat-config.json
        
        # Compile for iOS
        python -m mlc_llm compile ../config/mlc-chat-config.json \
          --device iphone \
          --output ../output/model-iphone.tar
        
    - name: Extract compiled files
      run: |
        cd output
        tar -xvf model-iphone.tar
        echo "=== Extracted files ==="
        ls -lh
        ls -lh *.o 2>/dev/null || echo "No .o files"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-compiled-libs
        path: |
          output/*.o
          config/mlc-chat-config.json
        retention-days: 30
