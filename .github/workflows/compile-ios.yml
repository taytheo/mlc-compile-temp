name: Rebuild iOS model artifacts (lib0.o & devc.o)

on:
  workflow_dispatch:
    inputs:
      model_repo:
        description: 'Hugging Face repo to download (model weights)'
        required: true
        default: 'mlc-ai/Qwen3-4B-q4f16_1-MLC'
      xcode_version:
        description: 'Optional Xcode version label (unused, informational)'
        required: false

jobs:
  build-ios-artifacts:
    runs-on: macos-14
    timeout-minutes: 240

    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify runner architecture is Apple Silicon (arm64)
      run: |
        echo "uname -m: $(uname -m)"
        if [ "$(uname -m)" != "arm64" ]; then
          echo "ERROR: Runner architecture is not arm64 (Apple Silicon). This compilation requires Apple Silicon (arm64) to produce iPhone/Metal objects." \
               "If you need to run on Apple Silicon, use GitHub-hosted macOS arm64 runners or a self-hosted Apple Silicon runner."
          exit 1
        fi

    - name: Setup Conda (python environment)
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        activate-environment: mlc

    - name: Install MLC-LLM and deps
      run: |
        echo "Attempting to install mlc-llm nightly CPU wheels (preferred)"
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu || {
          echo "Nightly CPU wheels not found; falling back to stable/nightly without -cpu suffix"
          pip install --pre -U -f https://mlc.ai/wheels mlc-llm mlc-ai || {
            echo "ERROR: failed to install mlc-llm from index" && exit 1
          }
        }
        pip install huggingface_hub

    - name: Ensure Metal toolchain is available
      run: |
        echo "Checking Metal..."
        if ! xcrun metal --version >/dev/null 2>&1; then
          echo "Metal toolchain missing; downloading component... (may require sudo)"
          sudo xcodebuild -downloadComponent MetalToolchain || true
        fi
        xcrun metal --version || true

    - name: Apply json_ffi engine patch into installed package
      run: |
        python3 .github/scripts/patch_jsonffi_repl.py

    - name: Download model snapshot
      run: |
        mkdir -p model_weights
        echo "Downloading model: ${{ github.event.inputs.model_repo }}"
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='${{ github.event.inputs.model_repo }}', local_dir='./model_weights/target')"

    - name: Copy and adjust config for iOS (prefill=32, context=1024)
      run: |
        # update_mlc_config.py expects the model path layout used in other workflows; copy into the expected dir
        mkdir -p model_weights/Qwen3-4B-q4f16_1-MLC
        # if snapshot downloaded into model_weights/target, copy its contents
        if [ -d model_weights/target ]; then
          cp -R model_weights/target/* model_weights/Qwen3-4B-q4f16_1-MLC/ || true
        fi
        python3 .github/scripts/update_mlc_config.py

    - name: Compile for iPhone
      run: |
        mkdir -p output
        echo "=== Starting mlc_llm compile ==="
        python -m mlc_llm compile ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json --device iphone --output ./output/model-iphone.tar 2>&1 | tee compile_log.txt || (cat compile_log.txt && exit 1)

    - name: Extract compiled tar
      run: |
        if [ -f output/model-iphone.tar ]; then
          tar -xvf output/model-iphone.tar -C output || true
        fi
        echo "Contents of output/":
        ls -la output || true

    - name: Verify presence of lib0.o and devc.o
      run: |
        echo "Looking for lib0.o and devc.o"
        find output -type f -name 'lib0.o' -o -name 'devc.o' -print || true

    - name: Upload lib0.o and devc.o artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-objects-lib0-devc
        path: |
          output/**/lib0.o
          output/**/devc.o
        retention-days: 30
        if-no-files-found: warn

    - name: Upload full compile log
      uses: actions/upload-artifact@v4
      with:
        name: compile-log
        path: compile_log.txt
        retention-days: 30
