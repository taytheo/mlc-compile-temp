name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash -el {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.11"
          activate-environment: mlc

      - name: Install MLC-LLM Python package
        run: |
          pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
          pip install huggingface_hub

      - name: Patch MLC-LLM bool type bug
        run: |
          echo "ðŸ”§ MLC-LLM Bool íƒ€ìž… ë²„ê·¸ íŒ¨ì¹˜ ì‹œìž‘ (GitHub Issue #3389)"
          python3 .github/scripts/patch_mlc_bool_bug.py

      - name: Download model and create custom config
        run: |
          mkdir -p model_weights
          python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mlc-ai/Qwen3-4B-q4f16_1-MLC', local_dir='./model_weights/Qwen3-4B-q4f16_1-MLC')"
          cp ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json.bak
          python3 .github/scripts/update_mlc_config.py

      - name: Compile for iOS
        run: |
          mkdir -p ./output
          echo "=== Starting compilation ==="
          python -m mlc_llm compile \
            ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json \
            --device iphone \
            --output ./output/qwen3_q4f16_1-iphone.tar \
            2>&1 | tee compile_log.txt
          echo "=== Compilation output ==="
          ls -la ./output/

      - name: Extract compiled files
        if: success()
        run: |
          cd output
          if [ -f qwen3_q4f16_1-iphone.tar ]; then
            tar -xvf qwen3_q4f16_1-iphone.tar
            echo "=== Extracted files ==="
            ls -lh
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qwen3-4b-ios-compiled
          path: |
            output/*.o
            output/*.tar
            model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json
            compile_log.txt
          retention-days: 30
          if-no-files-found: warn
