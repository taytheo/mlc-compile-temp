name: Rebuild iOS model artifacts (lib0.o & devc.o)

on:
  workflow_dispatch:
    inputs:
      model_repo:
        description: 'Hugging Face repo to download (model weights)'
        required: true
        default: 'mlc-ai/Qwen3-4B-q4f16_1-MLC'
      xcode_version:
        description: 'Optional Xcode version label (unused, informational)'
        required: false

jobs:
  build-ios-artifacts:
    runs-on: macos-14
    timeout-minutes: 240

    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify runner architecture is Apple Silicon (arm64)
      run: |
        echo "uname -m: $(uname -m)"
        if [ "$(uname -m)" != "arm64" ]; then
          echo "ERROR: Runner architecture is not arm64 (Apple Silicon). This compilation requires Apple Silicon (arm64) to produce iPhone/Metal objects." \
               "If you need to run on Apple Silicon, use GitHub-hosted macOS arm64 runners or a self-hosted Apple Silicon runner."
          exit 1
        fi

    - name: Setup Conda (python environment)
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        activate-environment: mlc

    - name: Install MLC-LLM (pip wheels first) and deps
      run: |
        echo "Attempting to install mlc-llm wheels (preferred)"
        set -x
        # Try the CPU nightly wheels first
        if pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu; then
          echo "Installed mlc-llm from nightly cpu wheels"
        else
          echo "Nightly cpu wheels not available; trying general wheels"
          pip install --pre -U -f https://mlc.ai/wheels mlc-llm mlc-ai || true
        fi
        pip install huggingface_hub || true

        # Run patcher against installed site-packages (if present)
        python3 .github/scripts/patch_jsonffi_repl.py || true

        # Also clone the repository as a source fallback and copy the patch into it
        rm -rf mlc-llm-source || true
        git clone --depth 1 https://github.com/mlc-ai/mlc-llm.git mlc-llm-source || true
        if [ -d mlc-llm-source ]; then
          echo "Cloned mlc-llm into mlc-llm-source"
          mkdir -p mlc-llm-source/cpp/json_ffi
          cp .github/patches/json_ffi_engine.cc mlc-llm-source/cpp/json_ffi/json_ffi_engine.cc || true
          echo "--- head of patched file ---"
          head -n 80 mlc-llm-source/cpp/json_ffi/json_ffi_engine.cc || true
          if grep -q "MLCJSONFFIEngineForceLink_v1" mlc-llm-source/cpp/json_ffi/json_ffi_engine.cc; then
            echo "Marker present in local source"
          else
            echo "Marker not present in local source"
          fi
        else
          echo "No local source checkout cloned"
        fi

        # Provide visible debug about installed package
        python3 .github/scripts/show_installed_mlc_llm.py || true

    - name: Ensure Metal toolchain is available
      run: |
        echo "Checking Metal..."
        if ! xcrun metal --version >/dev/null 2>&1; then
          echo "Metal toolchain missing; downloading component... (may require sudo)"
          sudo xcodebuild -downloadComponent MetalToolchain || true
        fi
        xcrun metal --version || true

    - name: Apply json_ffi engine patch into installed package
      run: |
        echo "--- Debug: show available repo patches ---"
        ls -la .github/patches || true
        echo "--- Debug: head of patch file ---"
        sed -n '1,120p' .github/patches/json_ffi_engine.cc || true
        python3 .github/scripts/patch_jsonffi_repl.py

    - name: Upload patched json_ffi copies for debugging
      uses: actions/upload-artifact@v4
      with:
        name: patched-json-ffi-copies
        path: tmp_patched_jsonffi/
        retention-days: 7
        if-no-files-found: warn

    - name: Verify json_ffi patch applied to site-packages
      run: |
        echo "Searching for installed json_ffi_engine.cc and marker strings..."
        # Run verifier; on failure run diagnostics and fail-fast so we don't compile with an unpatched build
        if python3 .github/scripts/verify_jsonffi_patch.py; then
          echo "Verification passed"
        else
          echo "ERROR: json_ffi verification failed; collecting diagnostics and failing job"
          bash .github/scripts/ci_diagnostics.sh || true
          echo "Listing tmp_patched_jsonffi content (if any):"
          ls -la tmp_patched_jsonffi || true
          echo "Uploading diagnostics will occur in later steps via upload-artifact steps"
          exit 1
        fi

    - name: Show patched json_ffi copies (if any)
      run: |
        echo "Listing tmp_patched_jsonffi/"
        ls -la tmp_patched_jsonffi || true
        echo "Head of installed copy (if present):"
        head -n 120 tmp_patched_jsonffi/installed-json_ffi_engine.cc || true

    - name: Copy repo-local patch into workspace mlc-llm source (if available)
      run: |
        if [ -f .github/patches/json_ffi_engine.cc ] && [ -d mlc-llm ]; then
          echo "Copying repo-local patch into mlc-llm/cpp/json_ffi/"
          mkdir -p mlc-llm/cpp/json_ffi
          cp .github/patches/json_ffi_engine.cc mlc-llm/cpp/json_ffi/json_ffi_engine.cc
          echo "Installing editable mlc-llm from workspace to prefer local sources"
          pip install -e ./mlc-llm || true
        else
          echo "No local mlc-llm checkout available or patch missing; skipping editable install"
        fi

    - name: Clean mlc-llm build cache (best-effort)
      run: |
        echo "Removing mlc-llm caches"
        rm -rf ~/.cache/mlc_llm || true
        rm -rf /tmp/mlc_llm* || true
        ls -la ~/.cache || true

    - name: Download model snapshot
      run: |
        mkdir -p model_weights
        echo "Downloading model: ${{ github.event.inputs.model_repo }}"
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='${{ github.event.inputs.model_repo }}', local_dir='./model_weights/target')"

    - name: Copy and adjust config for iOS (prefill=32, context=1024)
      run: |
        # update_mlc_config.py expects the model path layout used in other workflows; copy into the expected dir
        mkdir -p model_weights/Qwen3-4B-q4f16_1-MLC
        # if snapshot downloaded into model_weights/target, copy its contents
        if [ -d model_weights/target ]; then
          cp -R model_weights/target/* model_weights/Qwen3-4B-q4f16_1-MLC/ || true
        fi
        python3 .github/scripts/update_mlc_config.py

    - name: Debug mlc_llm package layout
      run: |
        echo "mlc_llm package info and json_ffi sources (top results only)"
        python3 .github/scripts/debug_mlc_llm_package.py

    - name: Test local mlc_llm import (verifies PYTHONPATH / editable install)
      run: |
        echo "Running import tests to ensure the patched source or installed package can be imported"
        bash .github/scripts/test_local_mlc_llm_import.sh

    - name: Compile for iPhone (with debug-dump, prefer local source)
      run: |
        mkdir -p output tmp_debug_dump
        echo "=== Starting mlc_llm compile (with --debug-dump) ==="
        # If we have a local source checkout, prefer it by adding it to PYTHONPATH.
        if [ -d mlc-llm-source ]; then
          echo "Using local mlc-llm-source in PYTHONPATH"
          PYTHONPATH=./mlc-llm-source:./mlc-llm-source/src python -m mlc_llm compile ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json --device iphone --output ./output/model-iphone.tar --debug-dump ./tmp_debug_dump 2>&1 | tee compile_log.txt || (cat compile_log.txt && exit 1)
        else
          echo "No local source; using installed mlc-llm"
          python -m mlc_llm compile ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json --device iphone --output ./output/model-iphone.tar --debug-dump ./tmp_debug_dump 2>&1 | tee compile_log.txt || (cat compile_log.txt && exit 1)
        fi

    - name: Upload compile debug dump
      uses: actions/upload-artifact@v4
      with:
        name: compile-debug-dump
        path: tmp_debug_dump/
        retention-days: 7
        if-no-files-found: warn

    - name: "CI diagnostics: scan logs, debug-dump, and tmp dirs for jsonffi markers"
      run: |
        bash .github/scripts/ci_diagnostics.sh || true

    - name: Upload CI diagnostics artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ci-diagnostics
        path: tmp_ci_diagnostics/
        retention-days: 7
        if-no-files-found: warn

    - name: Extract compiled tar and list contents
      run: |
        if [ -f output/model-iphone.tar ]; then
          echo "Listing tar contents:"
          tar -tf output/model-iphone.tar || true
          echo "Extracting tar..."
          tar -xvf output/model-iphone.tar -C output || true
        else
          echo "ERROR: output/model-iphone.tar not found"
          ls -la output || true
          echo "Dumping potential mlc-llm build cache dirs..."
          ls -la /tmp || true
          ls -la ~/.cache || true
          exit 1
        fi
        echo "Contents of output/":
        ls -la output || true

    - name: Search build tree and artifacts for marker strings
      run: |
        # Search local workspace and output for our force-link marker or diagnostic markers
        echo "Searching workspace for MLCJSONFFIEngineForceLink and jsonffi markers..."
        grep -R --line-number "MLCJSONFFIEngineForceLink_v1\|jsonffi_contains_replacement" . || true
        echo "Searching output object files for marker strings..."
        for f in $(find output -type f -name '*.o' -print); do
          echo "Inspecting: $f"
          if strings "$f" | egrep -i 'MLCJSONFFIEngineForceLink|jsonffi_contains_replacement' -n >/dev/null; then
            echo "FOUND marker in $f"
            strings "$f" | egrep -i 'MLCJSONFFIEngineForceLink|jsonffi_contains_replacement' -n || true
          else
            echo "No marker in $f"
          fi
        done
        echo "Searching typical tmp/build dirs for marker strings (may be slow)"
        find /tmp -type f -name '*.o' -print -exec sh -c "strings '{}' | egrep -i 'MLCJSONFFIEngineForceLink|jsonffi_contains_replacement' -n && echo 'FOUND in {}'" \; || true

    - name: Verify presence and names of lib/devc objects
      run: |
        echo "Searching for lib0.o and devc-style object files..."
        set -x
        find output -type f \( -name 'lib0.o' -o -name '*devc*.o' -o -name '*_devc.o' \) -print > found_objs.txt || true
        if [ ! -s found_objs.txt ]; then
          echo "ERROR: No devc-style object found in output directory."
          echo "All output files:"
          ls -la output || true
          exit 1
        fi
        cat found_objs.txt
        # Inspect each object for marker strings and symbols
        MISSING_MARKER=0
        for f in $(cat found_objs.txt); do
          echo "Inspecting $f"
          if strings "$f" | egrep -i 'jsonffi_contains_replacement|MLCJSONFFIEngineForceLink|json_ffi' -n >/dev/null; then
            echo "Marker string found in $f"
          else
            echo "Marker string NOT found in $f"
            MISSING_MARKER=1
          fi
          if nm -g "$f" 2>/dev/null | egrep -i 'MLCJSONFFIEngineForceLink|jsonffi' >/dev/null; then
            echo "Public symbol found in $f"
          else
            echo "No public symbol for jsonffi found in $f"
          fi
        done
        if [ "$MISSING_MARKER" -eq 1 ]; then
          echo "ERROR: One or more object files do not contain the jsonffi marker; failing the job."
          exit 1
        fi

    - name: Upload lib0.o and devc.o artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-objects-lib0-devc
        path: |
          output/**/lib0.o
          output/**/devc.o
        retention-days: 30
        if-no-files-found: warn

    - name: Upload full compile log
      uses: actions/upload-artifact@v4
      with:
        name: compile-log
        path: compile_log.txt
        retention-days: 30
