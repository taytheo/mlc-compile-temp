name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180
    
    defaults:
      run:
        shell: bash -el {0}
    
    steps:
    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        activate-environment: mlc
        
    - name: Install MLC-LLM from prebuilt wheel
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install huggingface_hub
        pip show mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        
    - name: Download Pre-compiled Qwen3-4B MLC Model
      run: |
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mlc-ai/Qwen3-4B-q4f16_1-MLC', local_dir='./qwen3-4b-mlc')"
        echo "=== Downloaded model files ==="
        ls -la ./qwen3-4b-mlc/
        cat ./qwen3-4b-mlc/mlc-chat-config.json
        
    - name: Create patch script
      run: |
        cat > patch_bug.py << 'PYSCRIPT'
        import re
        import site
        import os
        
        site_packages = site.getsitepackages()[0]
        buggy_file = os.path.join(site_packages, "mlc_llm", "op", "batch_spec_verify.py")
        
        if not os.path.exists(buggy_file):
            print(f"File not found: {buggy_file}")
            exit(0)
        
        print(f"Patching: {buggy_file}")
        
        with open(buggy_file, 'r') as f:
            content = f.read()
        
        print("=== Before patch (relevant lines) ===")
        for i, line in enumerate(content.split('\n'), 1):
            if 'alloc_buffer' in line or 'done[' in line:
                print(f"{i}: {line}")
        
        # Fix 1: Change bool buffer to int32
        content = re.sub(
            r'T\.alloc_buffer\s*\(\s*\(\s*1\s*,\s*\)\s*,\s*["\']bool["\']\s*\)',
            'T.alloc_buffer((1,), "int32")',
            content
        )
        
        # Fix 2: Change boolean/T.int32 values to simple integers
        content = re.sub(r'done\[0\]\s*=\s*T\.int32\(0\)', 'done[0] = 0', content)
        content = re.sub(r'done\[0\]\s*=\s*T\.int32\(1\)', 'done[0] = 1', content)
        content = re.sub(r'done\[0\]\s*=\s*False', 'done[0] = 0', content)
        content = re.sub(r'done\[0\]\s*=\s*True', 'done[0] = 1', content)
        
        with open(buggy_file, 'w') as f:
            f.write(content)
        
        print("=== After patch (relevant lines) ===")
        for i, line in enumerate(content.split('\n'), 1):
            if 'alloc_buffer' in line or 'done[' in line:
                print(f"{i}: {line}")
        
        print("Patch applied successfully!")
        PYSCRIPT
        
    - name: Apply patch
      run: python patch_bug.py
        
    - name: Compile for iOS
      run: |
        mkdir -p ./output
        python -m mlc_llm compile ./qwen3-4b-mlc/mlc-chat-config.json --device iphone --output ./output/qwen3_q4f16_1-iphone.tar
        ls -la ./output/
        
    - name: Extract compiled files
      run: |
        cd output
        if [ -f qwen3_q4f16_1-iphone.tar ]; then
          tar -xvf qwen3_q4f16_1-iphone.tar
          ls -lh
        else
          echo "No tar file found"
          ls -la
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-compiled
        path: |
          output/*.o
          output/*.tar
          qwen3-4b-mlc/mlc-chat-config.json
        retention-days: 30
