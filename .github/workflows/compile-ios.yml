name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.11"
        activate-environment: mlc

    - name: Install dependencies
      run: |
        brew install cmake git-lfs
        git lfs install
        # Install Rust (required for tokenizers)
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        rustc --version

    - name: Clone MLC-LLM source
      run: |
        git clone --depth 1 https://github.com/mlc-ai/mlc-llm.git
        cd mlc-llm
        git submodule update --init --recursive

    - name: Install MLC-LLM Python package
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install huggingface_hub

    - name: Patch batch_spec_verify.py bug (bool type issue)
      run: |
        SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
        FILE="$SITE_PKG/mlc_llm/op/batch_spec_verify.py"
        echo "=== Patching $FILE ==="
        
        # Also patch the source copy
        SRC_FILE="mlc-llm/python/mlc_llm/op/batch_spec_verify.py"
        
        for F in "$FILE" "$SRC_FILE"; do
          if [ -f "$F" ]; then
            echo "Patching: $F"
            # Change bool type to int32 for done and pred variables
            sed -i '' 's/done = _var("bool")/done = _var("int32")/g' "$F"
            sed -i '' 's/pred_shared = T.alloc_buffer((1,), "bool", scope="shared")/pred_shared = T.alloc_buffer((1,), "int32", scope="shared")/g' "$F"
            sed -i '' 's/pred_local = T.alloc_buffer((1,), "bool", scope="local")/pred_local = T.alloc_buffer((1,), "int32", scope="local")/g' "$F"
            # Change boolean assignments to int
            sed -i '' 's/done\[0\] = False/done[0] = 0/g' "$F"
            sed -i '' 's/done\[0\] = True/done[0] = 1/g' "$F"
            # Change T.Not(done[0]) to done[0] == 0
            sed -i '' 's/while T.Not(done\[0\]):/while done[0] == 0:/g' "$F"
            # Change pred comparisons
            sed -i '' 's/if pred_local\[0\]:/if pred_local[0] != 0:/g' "$F"
            echo "=== Patched content (lines 85-125) ==="
            sed -n '85,125p' "$F"
          fi
        done

    - name: Create mlc-package-config.json for Qwen3
      run: |
        cd mlc-llm/ios/MLCChat
        cat > mlc-package-config.json << 'EOF'
        {
          "device": "iphone",
          "model_list": [
            {
              "model": "HF://mlc-ai/Qwen3-4B-q4f16_1-MLC",
              "model_id": "Qwen3-4B-q4f16_1",
              "estimated_vram_bytes": 3000000000,
              "overrides": {
                "prefill_chunk_size": 128,
                "context_window_size": 2048
              }
            }
          ]
        }
        EOF
        cat mlc-package-config.json

    - name: Build iOS libraries with mlc_llm package
      run: |
        cd mlc-llm/ios/MLCChat
        export MLC_LLM_SOURCE_DIR=$(cd ../.. && pwd)
        echo "MLC_LLM_SOURCE_DIR=$MLC_LLM_SOURCE_DIR"
        # Run the package command
        python -m mlc_llm package

    - name: List built artifacts
      run: |
        cd mlc-llm/ios/MLCChat
        echo "=== dist directory ==="
        ls -laR dist/ || echo "dist not found"
        echo "=== lib directory ==="
        ls -la dist/lib/ || echo "lib not found"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-compiled
        path: |
          mlc-llm/ios/MLCChat/dist/
        retention-days: 30
