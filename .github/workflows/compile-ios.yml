name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Checkout repo for patch script
      uses: actions/checkout@v4

    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.11"
        activate-environment: mlc

    - name: Install MLC-LLM from prebuilt wheel
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install huggingface_hub

    - name: Download Pre-compiled Qwen3-4B MLC Model
      run: |
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mlc-ai/Qwen3-4B-q4f16_1-MLC', local_dir='./qwen3-4b-mlc')"
        ls -la ./qwen3-4b-mlc/

    - name: Apply patch for batch_spec_verify bug
      run: python .github/scripts/patch_mlc_bug.py

    - name: Compile for iOS
      run: |
        mkdir -p ./output
        python -m mlc_llm compile ./qwen3-4b-mlc/mlc-chat-config.json --device iphone --output ./output/qwen3_q4f16_1-iphone.tar
        ls -la ./output/

    - name: Extract compiled files
      run: |
        cd output
        tar -xvf qwen3_q4f16_1-iphone.tar || true
        ls -lh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-compiled
        path: |
          output/*.o
          output/*.tar
          qwen3-4b-mlc/mlc-chat-config.json
        retention-days: 30
