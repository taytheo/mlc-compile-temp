name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180
    
    defaults:
      run:
        shell: bash -el {0}
    
    steps:
    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        activate-environment: mlc
        
    - name: Install MLC-LLM from prebuilt wheel
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install "huggingface_hub>=0.20.0"
        
        pip show mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        
    - name: Download Pre-compiled Qwen3-4B MLC Model
      run: |
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mlc-ai/Qwen3-4B-q4f16_1-MLC', local_dir='./qwen3-4b-mlc'); print('Download complete')"
        
        echo "=== Downloaded model files ==="
        ls -la ./qwen3-4b-mlc/
        cat ./qwen3-4b-mlc/mlc-chat-config.json
        
    - name: Patch batch_spec_verify bug
      run: |
        SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
        BUGGY_FILE="$SITE_PACKAGES/mlc_llm/op/batch_spec_verify.py"
        
        if [ -f "$BUGGY_FILE" ]; then
          echo "Patching: $BUGGY_FILE"
          cp "$BUGGY_FILE" "$BUGGY_FILE.bak"
          
          # Use sed to fix the bug - change bool buffer to int32 and boolean values to integers
          sed -i.tmp 's/T\.alloc_buffer((1,), "bool")/T.alloc_buffer((1,), "int32")/g' "$BUGGY_FILE"
          sed -i.tmp 's/done\[0\] = False/done[0] = 0/g' "$BUGGY_FILE"
          sed -i.tmp 's/done\[0\] = True/done[0] = 1/g' "$BUGGY_FILE"
          
          echo "=== Patched lines ==="
          grep -n "done\[0\]" "$BUGGY_FILE" || echo "Checking alloc_buffer..."
          grep -n "alloc_buffer" "$BUGGY_FILE" | head -5
        else
          echo "File not found at $BUGGY_FILE, listing site-packages..."
          ls -la "$SITE_PACKAGES/mlc_llm/op/" || echo "mlc_llm/op not found"
        fi
        
    - name: Compile for iOS
      run: |
        mkdir -p ./output
        
        python -m mlc_llm compile ./qwen3-4b-mlc/mlc-chat-config.json \
          --device iphone \
          --output ./output/qwen3_q4f16_1-iphone.tar
        
        echo "=== Compiled output ==="
        ls -la ./output/
        
    - name: Extract compiled files
      run: |
        cd output
        if [ -f qwen3_q4f16_1-iphone.tar ]; then
          tar -xvf qwen3_q4f16_1-iphone.tar
          ls -lh
          tar -tvf qwen3_q4f16_1-iphone.tar
        else
          echo "No tar file found"
          ls -la
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-compiled
        path: |
          output/*.o
          output/*.tar
          qwen3-4b-mlc/mlc-chat-config.json
          qwen3-4b-mlc/*.bin
        retention-days: 30
