name: Compile MLC-LLM for iOS

on:
  workflow_dispatch:

jobs:
  compile-ios:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Setup Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.11"
        activate-environment: mlc

    - name: Install dependencies
      run: |
        brew install cmake git-lfs
        git lfs install
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        rustc --version

    - name: Clone MLC-LLM source
      run: |
        git clone https://github.com/mlc-ai/mlc-llm.git
        cd mlc-llm
        git log --oneline -20
        git submodule update --init --recursive

    - name: Install MLC-LLM Python package
      run: |
        pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
        pip install huggingface_hub

    - name: Patch bool type bugs in mlc_llm
      run: |
        SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
        echo "Site packages: $SITE_PKG"
        for F in "$SITE_PKG/mlc_llm/op/"*.py; do
          if [ -f "$F" ]; then
            sed -i '' 's/_var("bool")/_var("int32")/g' "$F"
            sed -i '' 's/"bool", scope="shared"/"int32", scope="shared"/g' "$F"
            sed -i '' 's/"bool", scope="local"/"int32", scope="local"/g' "$F"
            sed -i '' 's/(1,), "bool"/(1,), "int32"/g' "$F"
            sed -i '' 's/\[0\] = False/[0] = 0/g' "$F"
            sed -i '' 's/\[0\] = True/[0] = 1/g' "$F"
          fi
        done
        echo "MLC-LLM patch complete"

    - name: Patch bool type bugs in TVM
      run: |
        SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
        echo "Patching TVM files in: $SITE_PKG/tvm"
        find "$SITE_PKG/tvm" -name "*.py" -exec grep -l "uint1\|\"bool\"" {} \; | while read F; do
          echo "Patching: $F"
          sed -i '' 's/"bool"/"int32"/g' "$F" || true
          sed -i '' 's/uint1/int32/g' "$F" || true
        done
        if [ -f "$SITE_PKG/tvm/relax/backend/gpu_generic/sampling.py" ]; then
          echo "Special patch for sampling.py"
          sed -i '' 's/dtype="bool"/dtype="int32"/g' "$SITE_PKG/tvm/relax/backend/gpu_generic/sampling.py"
        fi
        echo "TVM patch complete"

    - name: Download model weights
      run: |
        mkdir -p model_weights
        python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mlc-ai/Qwen3-4B-q4f16_1-MLC', local_dir='./model_weights/Qwen3-4B-q4f16_1-MLC')"
        ls -la ./model_weights/Qwen3-4B-q4f16_1-MLC/

    - name: Try compile
      continue-on-error: true
      id: compile
      run: |
        mkdir -p ./output
        TVM_BACKTRACE=1 python -m mlc_llm compile ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json --device iphone --output ./output/qwen3_q4f16_1-iphone.tar 2>&1 | tee compile_log.txt || echo "Compilation failed"
        if [ -f ./output/qwen3_q4f16_1-iphone.tar ]; then
          echo "compile_success=true" >> $GITHUB_OUTPUT
        else
          echo "compile_success=false" >> $GITHUB_OUTPUT
        fi
        ls -la ./output/ || echo "No output"

    - name: Download prebuilt MLC iOS libraries (fallback)
      if: steps.compile.outputs.compile_success != 'true'
      run: |
        echo "Compilation failed, downloading pre-built libraries..."
        mkdir -p ./prebuilt-libs
        cd mlc-llm
        git submodule update --init --recursive 3rdparty/tvm
        ls -la ios/MLCChat/ || true
        echo "Pre-built iOS package structure available in mlc-llm/ios/"

    - name: Prepare artifacts
      run: |
        mkdir -p ./prebuilt
        cp ./model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json ./prebuilt/ || true
        ls -la ./model_weights/Qwen3-4B-q4f16_1-MLC/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qwen3-4b-ios-artifacts
        path: |
          output/
          prebuilt/
          model_weights/Qwen3-4B-q4f16_1-MLC/mlc-chat-config.json
          model_weights/Qwen3-4B-q4f16_1-MLC/tokenizer.json
          compile_log.txt
        retention-days: 30
        if-no-files-found: warn
